<html lang="en-US">
    <head>
        <title>CoolWHIP</title>
        <style>
            video {
                width: 1280px;
                height: 720px;
            }
        </style>
        <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    </head>
    <body>
    <video id="remoteView" autoplay>

    </video>
    <video id="selfView" width="400" autoplay muted></video>

    <button onclick="start()">Start</button>

    <video id="leftVideo" playsinline controls muted>
        <!-- NB CORS: https://bugzilla.mozilla.org/show_bug.cgi?id=1177793 -->
        <source src="./chrome.webm" type="video/webm"/>
        <source src="./chrome.mp4" type="video/mp4"/>
        <p>This browser does not support the video element.</p>
    </video>

    <video id="rightVideo" playsinline autoplay controls></video>
    </body>

    <script type="text/javascript">
        let remoteView;
        let selfView;

        remoteView = document.getElementById("remoteView");
        selfView = document.getElementById("selfView");

        const leftVideo = document.getElementById('leftVideo');
        const rightVideo = document.getElementById('rightVideo');

        const signaling = new WebSocket("ws://localhost:8000/ws")

        const constraints = {audio: true, video: true};

        const configuration = {iceServers: [{urls: 'stun:stun.l.google.com:19302'}]};
        const pc = new RTCPeerConnection(configuration);

        // Send any ice candidates to the other peer.
        //pc.onicecandidate = ({candidate}) => signaling.send(JSON.stringify(candidate));

        // Let the "negotiationneeded" event trigger offer generation.
        pc.onnegotiationneeded = async () => {
            try {
                await pc.setLocalDescription(await pc.createOffer());
                // Send the offer to the other peer.
                signaling.send(JSON.stringify({desc: btoa(JSON.stringify(pc.localDescription))}));
            } catch (err) {
                console.error(err);
            }
        };

        // Once remote track media arrives, show it in remote video element.
        pc.ontrack = (event) => {
            // Don't set srcObject again if it is already set.
            if (remoteView.srcObject !== event.streams[0]) {
                remoteView.srcObject = event.streams[0];
            }
        };

        // Call start() to initiate.
        async function start() {
            try {
                // Get local stream, show it in self-view, and add it to be sent.
                const stream =
                    await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach((track) =>
                    pc.addTrack(track, stream));

                selfView.srcObject = stream;
            } catch (err) {
                console.error(err);
            }
        }

        signaling.onmessage = async event => {
            const data = JSON.parse(event.data);

            let desc = data.desc;
            let candidate = data.candidate;

            try {
                if (desc) {
                    desc = atob(desc);
                    desc = JSON.parse(desc);
                    // If you get an offer, you need to reply with an answer.
                    if (desc.type === 'offer') {
                        console.log(desc);
                        await pc.setRemoteDescription(desc);
                        const stream =
                            await navigator.mediaDevices.getUserMedia(constraints);
                        stream.getTracks().forEach((track) =>
                            pc.addTrack(track, stream));
                        await pc.setLocalDescription(await pc.createAnswer());
                        signaling.send(JSON.stringify({desc: btoa(JSON.stringify(pc.localDescription))}));
                    } else if (desc.type === 'answer') {
                        await pc.setRemoteDescription(desc);
                    } else {
                        console.log('Unsupported SDP type.');
                    }
                } else if (candidate) {
                    await pc.addIceCandidate(candidate);
                }
            } catch (err) {
                console.error(err);
            }
        };

    </script>
</html>